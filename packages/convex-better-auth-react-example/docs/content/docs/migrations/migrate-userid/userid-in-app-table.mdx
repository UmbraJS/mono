---
title: Component user id in app table
description: Migrate user id reference from component to app table
---

<Callout>
  This guide shows one of two recommended strategies for migrating away from
  maintaining a `user.userId` field in the Better Auth user table. Read [the
  overview](/migrations/migrate-userid) for more information.
</Callout>

<Callout type="warning">
  The migration guide covers basic required changes, but your application may
  have additional or altered requirements depending on how the Better Auth
  component is implemented. Be sure to review any auth related code for
  potential impacts. Avoid type assertions and checking for type errors is
  encouraged.
</Callout>

This guide is for migrating from tracking the app user id in the component to
tracking the component user id in the app user table via an `authId` field.

<div className="fd-steps">

<div className="fd-step">

### Run convex dev

Keep the Convex dev server running while following the migration steps.

```npm
npx convex dev
```

</div>

  <div className="fd-step">

### Install migrations component

Install and configure the [migrations component](https://www.convex.dev/components/migrations).

```npm
npm install @convex-dev/migrations
```

```ts title="convex/convex.config.ts"
import { defineApp } from "convex/server";
import betterAuth from "@convex-dev/better-auth/convex.config";
import migrations from "@convex-dev/migrations/convex.config"; // [!code ++]

const app = defineApp();
app.use(betterAuth);
app.use(migrations); // [!code ++]

export default app;
```

  </div>

  <div className="fd-step">

### Add `authId` field to users table

Add an `authId` field to your app users table. You can use any name you want,
but keep in mind that this guide will refer to it as `authId`. The field should
be optional for now, it can be changed to required later.

```ts title="convex/schema.ts"
export default defineSchema({
  users: defineTable({
    email: v.string(),
    authId: v.optional(v.string()), // [!code ++]
  })
    .index("email", ["email"])
    .index("authId", ["authId"]), // [!code ++]
  // ...
});
```

</div>

  <div className="fd-step">
### Add migration functions

Create a `convex/migrations.ts` file and add migration functions. Two functions
are added - one for adding the `authId` field to the app users table, and one for
removing the `userId` field from the related Better Auth user. We'll run them in
later steps.

```ts title="convex/migrations.ts"
import { Migrations } from "@convex-dev/migrations";
import { components, internal } from "./_generated/api";
import type { DataModel } from "./_generated/dataModel";
import { authComponent } from "./auth";

export const migrations = new Migrations<DataModel>(components.migrations);

// Define migration functions
export const migrationAddAuthId = migrations.define({
  table: "users",
  migrateOne: async (ctx, user) => {
    // For each user in the app users table, get the related Better Auth user id
    // and set it to the `authId` field.
    if (user.authId === undefined) {
      const authUser = await authComponent.migrationGetUser(ctx, user._id);
      if (!authUser) {
        throw new Error(`Auth user not found for id ${user._id}`);
      }
      await ctx.db.patch(user._id, { authId: authUser._id });
    }
  },
});

export const migrationRemoveUserId = migrations.define({
  table: "users",
  migrateOne: async (ctx, user) => {
    // For each user in the app users table, remove the `userId` value from the
    // related Better Auth user
    await authComponent.migrationRemoveUserId(ctx, user._id);
  },
});

// Export runnable migration functions
export const addAuthId = migrations.runner(
  internal.migrations.migrationAddAuthId
);

export const removeUserId = migrations.runner(
  internal.migrations.migrationRemoveUserId
);
```

  </div>

  <div className="fd-step">
### Update adapter exports (Local Install only)

If using [Local Install](/local-install), update the adapter exports to include the `migrationRemoveUserId` function.

```ts title="convex/betterAuth/adapter.ts"
export const {
  create,
  findOne,
  findMany,
  updateOne,
  updateMany,
  deleteOne,
  deleteMany,
  migrationRemoveUserId, // [!code ++]
} = createApi(schema, createAuth);
```

  </div>

<div className="fd-step">
  ### Update user triggers

Update user triggers to set the user `authId` field on creation, and use it to
get the app user on update and delete.

Depending on how you're using Better Auth, you may or may not be using all of
these triggers.

```ts title="convex/auth.ts"
export const authComponent = createClient<DataModel, typeof betterAuthSchema>(
  components.betterAuth,
  {
    authFunctions,
    triggers: {
      user: {
        onCreate: async (ctx, authUser) => {
          const userId = await ctx.db.insert("users", {
            email: authUser.email,
            authId: authUser._id, // [!code ++]
          });
          await authComponent.setUserId(ctx, authUser._id, userId);
        },
      onUpdate: async (ctx, authUser, prevAuthUser) => {
        // Example trigger logic for syncing email address, your logic
        // and details may differ
        if (authUser.email !== prevAuthUser.email) {
          // [!code ++:6]
          const user = await ctx.db.query("users")
            .withIndex("authId", (q) => q.eq("authId", authUser._id))
            .unique();
          if (!user) {
            throw new ConvexError('User not found')
          }
          await ctx.db.patch(authUser.authId as Id<'users'>, { // [!code --]
          await ctx.db.patch(user._id, { // [!code ++]
            email: authUser.email,
          })
        }
      },
      onDelete: async (ctx, authUser) => {
        // Example logic, your logic and details may differ
        await ctx.db.delete(authUser.userId as Id<'users'>) // [!code --]
        // [!code ++:6]
        const user = await ctx.db.query("users")
          .withIndex("authId", (q) => q.eq("authId", authUser._id))
          .unique();
        if (!user) {
          throw new ConvexError('User not found')
        }
        await ctx.db.delete(authUser.userId as Id<'users'>) // [!code --]
        await ctx.db.delete(user._id) // [!code ++]
      },
        // ...
      },
    },
  }
);
```

</div>

<div className="fd-step">
  ### Run `addAuthId` migration

At this point, with the convex dev server running, your code is still
functioning as it did prior to starting this guide, but is now also defining
`authId` on every new user, so all new users moving forward will have an
`authId` value.

**This migration will backfill the `authId` field for previously existing
users in your development deployment.**

```npm
npx convex run migrations:addAuthId
```

</div>

<div className="fd-step">
  ### Deploy to production

<Callout type="warning">
  Before proceeding, make sure the migration was successful in your development
  deployment by running your application locally. Also confirm that the `authId`
  field on all users in your development deployment app user table is set.
</Callout>

The changes made so far, which are strictly additive and not destructive, should
be deployed to production. The first migration will need to run there as well.

Deployment steps depend on how you deploy your app. Most apps deploy through
Netlify or Vercel by merging changes to the main branch of their project repo.

</div>

<div className="fd-step">
  ### Run `addAuthId` migration in production

With production successfully deployed, the migration can be run against the
production deployment. This can happen through the production deployment
dashboard, or through the cli using the `--prod` flag.

```npm
npx convex run migrations:addAuthId --prod
```

</div>

<div className="fd-step">
### Make `authId` required

Now that all `authId` values are set, make the `authId` field required in the
app user table. If the convex dev server errors after this change, you probably
have one or more users in the app user table that don't have an `authId` value.
This should only be possible for users that do not have a related Better Auth user.

```ts title="convex/schema.ts"
export default defineSchema({
  users: defineTable({
    email: v.string(),
    authId: v.optional(v.string()), // [!code --]
    authId: v.string(), // [!code ++]
  }).index("email", ["email"]),
});
```

</div>

<div className="fd-step">
### Remove `userId` writes

Update the user onCreate trigger to stop setting the `userId` field on the Better Auth user.

```ts title="convex/auth.ts"
export const authComponent = createClient<DataModel>(components.betterAuth, {
  authFunctions,
  triggers: {
    user: {
      onCreate: async (ctx, authUser) => {
        await ctx.db.insert("users", {
          email: authUser.email,
          authId: authUser._id,
        });
        await authComponent.setUserId(ctx, authUser._id, userId); // [!code --]
      },
    },
  },
});
```

</div>

<div className="fd-step">
  ### Update `userId` references

Any references in your codebase to the `userId` field from the Better Auth user
should be updated to reference the `authId` field in the app user table. Your
app may not have any such references.

```ts title="convex/auth.ts"
export const getCurrentUser = query({
  args: {},
  handler: async (ctx) => {
    const authUser = await authComponent.safeGetAuthUser(ctx);
    if (!authUser) {
      return;
    }
    const user = await ctx.db.get(authUser.userId as Id<"users">); // [!code --]
    // [!code ++:4]
    const user = await ctx.db
      .query("users")
      .withIndex("authId", (q) => q.eq("authId", authUser._id))
      .unique();
    if (!user) {
      return;
    }
    return { ...user, ...withoutSystemFields(authUser) };
  },
});
```

</div>

<div className="fd-step">
  ### Run `removeUserId` migration

The migration is now functionally complete, all that remains are unused
`userId` values in the Better Auth user table.

Run the `removeUserId` migration to clear the unused values.

```npm
npx convex run migrations:removeUserId
```

</div>

<div className="fd-step">
  ### Deploy to production

After ensuring your application works after these changes, and that the
`userId` field is no longer being set on the Better Auth user table, changes
should be deployed to production.

</div>

<div className="fd-step">
  ### Run `removeUserId` migration in production

Once deployed, as we did previously, the second migration should also be run in production.

```npm
npx convex run migrations:removeUserId --prod
```

</div>

<div className="fd-step">
  ### Remove migration code

Remove the migration dependencies and code added previously.

<Callout>
  Only remove the migration component if not used elsewhere in your project.
</Callout>

```npm
npm uninstall @convex-dev/migrations
```

```ts title="convex/convex.config.ts"
import { defineApp } from "convex/server";
import betterAuth from "@convex-dev/better-auth/convex.config";
import migrations from "@convex-dev/migrations/convex.config"; // [!code --]

const app = defineApp();
app.use(betterAuth);
app.use(migrations); // [!code --]

export default app;
```

```ts title="convex/migrations.ts"
// [!code --:40]
import { Migrations } from "@convex-dev/migrations";
import { components, internal } from "./_generated/api";
import type { DataModel } from "./_generated/dataModel";
import { authComponent } from "./auth";

export const migrations = new Migrations<DataModel>(components.migrations);

// Define migration functions
export const migrationAddAuthId = migrations.define({
  table: "users",
  migrateOne: async (ctx, user) => {
    // For each user in the app users table, get the related Better Auth user id
    // and set it to the `authId` field.
    if (user.authId === undefined) {
      const authUser = await authComponent.migrationGetUser(ctx, user._id);
      if (!authUser) {
        throw new Error(`Auth user not found for id ${user._id}`);
      }
      await ctx.db.patch(user._id, { authId: authUser._id });
    }
  },
});

export const migrationRemoveUserId = migrations.define({
  table: "users",
  migrateOne: async (ctx, user) => {
    // For each user in the app users table, remove the `userId` value from the
    // related Better Auth user
    await authComponent.migrationRemoveUserId(ctx, user._id);
  },
});

// Export runnable migration functions
export const addAuthId = migrations.runner(
  internal.migrations.migrationAddAuthId
);

export const removeUserId = migrations.runner(
  internal.migrations.migrationRemoveUserId
);
```

<Callout>This file only exists if using Local Install.</Callout>

```ts title="convex/betterAuth/adapter.ts"
export const {
  create,
  findOne,
  findMany,
  updateOne,
  updateMany,
  deleteOne,
  deleteMany,
  migrationRemoveUserId, // [!code --]
} = createApi(schema, createAuth);
```

</div>

<div className="fd-step">
  ### Migration complete ðŸŽ‰

You've successfully migrated your user table foreign key from Better Auth into
your app user table.

</div>

</div>
