---
title: TanStack Start
description: Install and configure Convex + Better Auth for TanStack Start.
---

<Callout>
  Check out a complete Convex + Better Auth example with TanStack Start in the
  [GitHub
  repo](https://github.com/get-convex/better-auth/tree/main/examples/tanstack).
</Callout>

## Installation

<div className="fd-steps">

  <div className="fd-step">
    ### Install packages

    Install the component, a pinned version of Better Auth, and ensure the latest version
    of Convex.

    <Callout>This component requires Convex `1.25.0` or later.</Callout>

    ```npm
    npm install convex@latest @convex-dev/better-auth
    npm install better-auth@1.3.27 --save-exact
    ```

  </div>

  <div className="fd-step">
    ### Register the component

    Register the Better Auth component in your Convex project.

    ```ts title="convex/convex.config.ts"
    import { defineApp } from "convex/server";
    import betterAuth from "@convex-dev/better-auth/convex.config";

    const app = defineApp();
    app.use(betterAuth);

    export default app;
    ```

  </div>

  <div className="fd-step">
    ### Add Convex auth config

    Add a `convex/auth.config.ts` file to configure Better Auth as an authentication provider.

    ```ts title="convex/auth.config.ts"
    export default {
      providers: [
        {
          domain: process.env.CONVEX_SITE_URL,
          applicationID: "convex",
        },
      ],
    };
    ```

  </div>

  <div className="fd-step">
    ### Set environment variables

    Generate a secret for encryption and generating hashes. Use the command below if you have openssl installed, or use the button to generate a random value instead. Or generate your own however you like.

    ```shell
    npx convex env set BETTER_AUTH_SECRET=$(openssl rand -base64 32)
    ```

    Add your site URL to your Convex deployment.

    ```shell
    npx convex env set SITE_URL http://localhost:3000
    ```

    Add environment variables to the `.env.local` file created by `npx convex dev`. It will be picked up by your framework dev server.

    ```shell title=".env.local" tab="Cloud"
    # Deployment used by \`npx convex dev\`
    CONVEX_DEPLOYMENT=dev:adjective-animal-123 # team: team-name, project: project-name

    VITE_CONVEX_URL=https://adjective-animal-123.convex.cloud

    # Same as VITE_CONVEX_URL but ends in .site // [!code ++]
    VITE_CONVEX_SITE_URL=https://adjective-animal-123.convex.site # [!code ++]

    # Your local site URL // [!code ++]
    SITE_URL=http://localhost:3000 # [!code ++]
    ```

    ```shell title=".env.local" tab="Self hosted"
    # Deployment used by \`npx convex dev\`
    CONVEX_DEPLOYMENT=dev:adjective-animal-123 # team: team-name, project: project-name

    VITE_CONVEX_URL=http://127.0.0.1:3210

    # Will generally be one number higher than VITE_CONVEX_URL,
    # so if your convex url is :3212, your site url will be :3213
    VITE_CONVEX_SITE_URL=http://127.0.0.1:3211 # [!code ++]

    # Your local site URL // [!code ++]
    SITE_URL=http://localhost:3000 # [!code ++]
    ```

  </div>

  <div className="fd-step">
    ### Create a Better Auth instance

    Create a Better Auth instance and initialize the component.

    <Callout>Some Typescript errors will show until you save the file.</Callout>

    ```ts title="convex/auth.ts"
    import { createClient, type GenericCtx } from "@convex-dev/better-auth";
    import { convex } from "@convex-dev/better-auth/plugins";
    import { components } from "./_generated/api";
    import { DataModel } from "./_generated/dataModel";
    import { query } from "./_generated/server";
    import { betterAuth } from "better-auth";

    const siteUrl = process.env.SITE_URL!;

    // The component client has methods needed for integrating Convex with Better Auth,
    // as well as helper methods for general use.
    export const authComponent = createClient<DataModel>(components.betterAuth);

    export const createAuth = (
      ctx: GenericCtx<DataModel>,
      { optionsOnly } = { optionsOnly: false },
    ) => {
      return betterAuth({
        // disable logging when createAuth is called just to generate options.
        // this is not required, but there's a lot of noise in logs without it.
        logger: {
          disabled: optionsOnly,
        },
        baseURL: siteUrl,
        database: authComponent.adapter(ctx),
        // Configure simple, non-verified email/password to get started
        emailAndPassword: {
          enabled: true,
          requireEmailVerification: false,
        },
        plugins: [
          // The Convex plugin is required for Convex compatibility
          convex(),
        ],
      });
    };

    // Example function for getting the current user
    // Feel free to edit, omit, etc.
    export const getCurrentUser = query({
      args: {},
      handler: async (ctx) => {
        return authComponent.getAuthUser(ctx);
      },
    });
    ```

  </div>

  <div className="fd-step">
    ### Create a Better Auth client instance

    Create a Better Auth client instance for interacting with the Better Auth server from your client.

    ```ts title="src/lib/auth-client.ts"
    import { createAuthClient } from "better-auth/react";
    import { convexClient } from "@convex-dev/better-auth/client/plugins";

    export const authClient = createAuthClient({
      plugins: [convexClient()],
    });
    ```

  </div>

  <div className="fd-step">
    ### Mount handlers

    Register Better Auth route handlers on your Convex deployment.

    ```ts title="convex/http.ts"
    import { httpRouter } from "convex/server";
    import { authComponent, createAuth } from "./auth";

    const http = httpRouter();

    authComponent.registerRoutes(http, createAuth);

    export default http;
    ```

    Set up route handlers to proxy auth requests from TanStack Start to your Convex deployment.

    ```ts title="src/routes/api/auth/$.ts"
    import { createFileRoute } from '@tanstack/react-router'
    import { reactStartHandler } from '@convex-dev/better-auth/react-start'

    export const Route = createFileRoute('/api/auth/$')({
      server: {
        handlers: {
          GET: ({ request }) => {
            return reactStartHandler(request)
          },
          POST: ({ request }) => {
            return reactStartHandler(request)
          },
        },
      },
    })
    ```

  </div>

  <div className="fd-step">
    ### Set up root route

    Wrap your application root with `ConvexBetterAuthProvider` and make auth available in loaders.

    ```ts title="src/routes/__root.tsx"
    /// <reference types="vite/client" />
    import * as React from 'react'
    import appCss from '@/styles/app.css?url'
    import {
      Outlet,
      createRootRouteWithContext,
      HeadContent,
      Scripts,
      useRouteContext, // [!code ++]
    } from '@tanstack/react-router'
    // [!code ++:8]
    import { createServerFn } from '@tanstack/react-start'
    import { QueryClient } from '@tanstack/react-query'
    import { ConvexQueryClient } from '@convex-dev/react-query'
    import { ConvexReactClient } from 'convex/react'
    import { getCookie, getRequest } from '@tanstack/react-start/server'
    import { ConvexBetterAuthProvider } from '@convex-dev/better-auth/react'
    import { fetchSession, getCookieName } from '@convex-dev/better-auth/react-start'
    import { authClient } from "@/lib/auth-client";

    // [!code ++:11]
    // Get auth information for SSR using available cookies
    const fetchAuth = createServerFn({ method: 'GET' }).handler(async () => {
      const { createAuth } = await import('../../convex/auth')
      const { session } = await fetchSession(getRequest())
      const sessionCookieName = getCookieName(createAuth)
      const token = getCookie(sessionCookieName)
      return {
        userId: session?.user.id,
        token,
      }
    })

    export const Route = createRootRouteWithContext<{
      queryClient: QueryClient
      convexClient: ConvexReactClient // [!code ++]
      convexQueryClient: ConvexQueryClient // [!code ++]
    }>()({
      head: () => ({
        meta: [
          {
            charSet: 'utf-8',
          },
          {
            name: 'viewport',
            content: 'width=device-width, initial-scale=1',
          },
        ],
        links: [
          { rel: 'stylesheet', href: appCss },
          { rel: 'icon', href: '/favicon.ico' },
        ],
      }),
      // [!code ++:14]
      beforeLoad: async (ctx) => {
        // all queries, mutations and action made with TanStack Query will be
        // authenticated by an identity token.
        const { userId, token } = await fetchAuth()

        // During SSR only (the only time serverHttpClient exists),
        // set the auth token to make HTTP queries with.
        if (token) {
          ctx.context.convexQueryClient.serverHttpClient?.setAuth(token)
        }

        return { userId, token }
      },
      component: RootComponent,
    })

    function RootComponent() {
      const context = useRouteContext({ from: Route.id })
      return (
        // [!code ++:4]
        <ConvexBetterAuthProvider
          client={context.convexClient}
          authClient={authClient}
        >
          <RootDocument>
            <Outlet />
          </RootDocument>
        </ConvexBetterAuthProvider> // [!code ++]
      )
    }

    function RootDocument({ children }: { children: React.ReactNode }) {
      return (
        <html lang="en" className="dark">
          <head>
            <HeadContent />
          </head>
          <body className="bg-neutral-950 text-neutral-50">
            {children}
            <Scripts />
          </body>
        </html>
      )
    }
    ```

  </div>
  
  <div className="fd-step">
    ### Add route context

    Provide context from Convex to your routes.
    ```ts title="src/routes/router.tsx"
    import { createRouter } from '@tanstack/react-router'
    import { routeTree } from './routeTree.gen'
    import { routerWithQueryClient } from '@tanstack/react-router-with-query'
    import { ConvexProvider, ConvexReactClient } from 'convex/react'
    import { ConvexQueryClient } from '@convex-dev/react-query'
    import { QueryClient } from '@tanstack/react-query'

    export function getRouter() {
      const CONVEX_URL = (import.meta as any).env.VITE_CONVEX_URL!
      if (!CONVEX_URL) {
        throw new Error('missing VITE_CONVEX_URL envar')
      }
      // [!code ++:4]
      const convex = new ConvexReactClient(CONVEX_URL, {
        unsavedChangesWarning: false,
      })
      const convexQueryClient = new ConvexQueryClient(convex)

      const queryClient: QueryClient = new QueryClient({
        defaultOptions: {
          queries: {
            queryKeyHashFn: convexQueryClient.hashFn(),
            queryFn: convexQueryClient.queryFn(),
          },
        },
      })
      convexQueryClient.connect(queryClient)

      const router = routerWithQueryClient(
        createRouter({
          routeTree,
          defaultPreload: 'intent',
          scrollRestoration: true,
          context: { queryClient, convexClient: convex, convexQueryClient }, // [!code ++]
          Wrap: ({ children }) => (
            <ConvexProvider client={convexQueryClient.convexClient}>
              {children}
            </ConvexProvider>
          ),
        }),
        queryClient,
      )

      return router
    }
    ```

  </div>
</div>

### You're done!

You're now ready to start using Better Auth with Convex.

## Usage

Check out the [Basic Usage](/basic-usage) guide for more information on general
usage. Below are usage notes specific to TanStack Start.

### Using Better Auth from the server

To use Better Auth's [server
methods](https://www.better-auth.com/docs/concepts/api) in server rendering,
server functions, or any other TanStack Start server code, use Convex functions
and call the function from your server code.

First, export helpers for calling Convex functions from your server code.

```ts title="src/lib/auth-server.ts"
import { createAuth } from "convex/auth";
import { setupFetchClient } from "@convex-dev/better-auth/react-start";
import { getCookie } from "@tanstack/react-start/server";

export const { fetchQuery, fetchMutation, fetchAction } =
  await setupFetchClient(createAuth, getCookie);
```

Here's an example Convex function that uses Better Auth's server methods, and
a TanStack server function that calls the Convex function.

```ts title="convex/users.ts"
import { mutation } from "./_generated/server";
import { v } from "convex/values";
import { createAuth, authComponent } from "./auth";

export const updateUserPassword = mutation({
  args: {
    currentPassword: v.string(),
    newPassword: v.string(),
  },
  handler: async (ctx, args) => {
    const { auth, headers } = await authComponent.getAuth(createAuth, ctx);
    await auth.api.changePassword({
      body: {
        currentPassword: args.currentPassword,
        newPassword: args.newPassword,
      },
      headers,
    });
  },
});
```

```ts title="src/routes/users.ts"
import { createServerFn } from "@tanstack/react-start";
import { fetchMutation } from "@/lib/auth-server";
import { api } from "../../convex/_generated/api";

export const updatePassword = createServerFn({ method: "POST" }).handler(
  async ({ data: { currentPassword, newPassword } }) => {
    await fetchMutation(api.users.updatePassword, {
      currentPassword,
      newPassword,
    });
  }
);
```
